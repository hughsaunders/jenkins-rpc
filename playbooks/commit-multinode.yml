---

## --------- [ Prepare Cluster ] ---------------
- include: packages.yml tags=prepare

- include: pip.yml tags=prepare

- include: networking.yml tags=prepare

- hosts: all
  tasks:
    - name: Create cinder volumes vg
      lvg:
        vg: "{{item.name}}"
        pvs: "{{item.device}}"
      with_items: vgs
  tags: prepare

- hosts: infrastructure[0]
  tags: prepare
  user: root
  roles:

    - configure-rpc-swift-lvs
    - setup-git

    - role: run-script-from-os-ansible-deployment
      script_name: bootstrap-ansible

    - configure-rpc-compute
    - configure-rpc-swift

## --------- [ Run os-ansible-deployment ] ---------------
- hosts: infrastructure[0]
  tags: run
  roles:
    - role: run-script-from-os-ansible-deployment
      script_name: run-playbooks
      script_env:
        DEPLOY_TEMPEST: "yes"

## --------- [ Test with tempest ] ---------------
- hosts: infrastructure[0]
  tags: test
  roles:
    - role: run-script-from-os-ansible-deployment
      script_name: run-tempest

## --------- [ Cleanup Cluster ] ---------------
- name: Rekick cluster nodes
  tags: clean
  gather_facts: False
  hosts: "all"
  tasks:
    - name: Rekick and wait for nodes to become available
      delegate_to: localhost
      rekick:
        host_ip: "{{ ansible_ssh_host }}"
        host_name: "{{ inventory_hostname }}"
        kick_wait: 2400
        kick_tries: 2
        djeep_url: "http://10.127.52.2:8000/api"
